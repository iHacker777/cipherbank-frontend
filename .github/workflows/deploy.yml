name: CipherBank Frontend - Blue/Green Deploy

on:
  push:
    branches: [ release ]  # â† FIXED: Changed from 'main' to 'release'
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - '.github/workflows/deploy.yml'  # â† FIXED: Changed from 'cipherbank-frontend-deploy.yml'
  workflow_dispatch:

env:
  APP_NAME: cipherbank-frontend
  NGINX_ROOT: /www/wwwroot/cipher.thepaytrix.com
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  SSH_HOST: ${{ secrets.GCP_HOST }}
  SSH_USER: ${{ secrets.GCP_USER }}
  SSH_KEY: ${{ secrets.GCP_SSH_KEY }}
  REACT_APP_API_URL: https://cipher.thepaytrix.com/api

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      # ==================== INITIALIZATION ====================
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ env.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸ“ Set Build Variables
        id: vars
        run: |
          echo "BUILD_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "COMMIT_MSG=$(git log -1 --pretty=%B | head -n1)" >> $GITHUB_OUTPUT
          echo "AUTHOR=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
          echo "VERSION=$(date +'%Y%m%d-%H%M%S')-${{ github.run_number }}" >> $GITHUB_OUTPUT
      
      - name: ğŸ“¢ Notify Deployment Start
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="ğŸ¨ <b>CipherBank Frontend Deployment Started</b>
          
          ğŸ“Š <b>Build Info</b>
          â€¢ Commit: <code>${{ steps.vars.outputs.COMMIT_SHA }}</code>
          â€¢ Author: ${{ steps.vars.outputs.AUTHOR }}
          â€¢ Version: ${ steps.vars.outputs.VERSION }}
          â€¢ Time: ${{ steps.vars.outputs.BUILD_TIME }}
          
          ğŸ’¬ <i>${{ steps.vars.outputs.COMMIT_MSG }}</i>
          
          â³ Installing dependencies..."
      
      # ==================== BUILD ====================
      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing npm packages..."
          npm ci
          echo "âœ… Dependencies installed"
      
      - name: ğŸ—ï¸ Build React App
        id: build
        env:
          CI: false  # Treat warnings as warnings, not errors
          GENERATE_SOURCEMAP: false  # Don't generate source maps in production
        run: |
          echo "ğŸ”¨ Starting React build..."
          npm run build
          
          if [ $? -eq 0 ] && [ -d "build" ]; then
            BUILD_SIZE=$(du -sh build | cut -f1)
            FILE_COUNT=$(find build -type f | wc -l)
            echo "build_size=$BUILD_SIZE" >> $GITHUB_OUTPUT
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            echo "âœ… Build successful: $FILE_COUNT files ($BUILD_SIZE)"
          else
            echo "âŒ Build failed"
            exit 1
          fi
      
      - name: ğŸ“¢ Notify Build Complete
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="âœ… Build completed
          â€¢ Size: ${{ steps.build.outputs.build_size }}
          â€¢ Files: ${{ steps.build.outputs.file_count }}
          â€¢ Uploading to server..."
      
      # ==================== DETECT ACTIVE VERSION ====================
      - name: ğŸ¨ Detect Active Version
        id: detect_version
        run: |
          CURRENT_LINK=$(ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
            "readlink ${{ env.NGINX_ROOT }}/current 2>/dev/null || echo 'none'")
          
          if [[ "$CURRENT_LINK" == *"blue"* ]]; then
            ACTIVE_VERSION="blue"
            DEPLOY_VERSION="green"
          elif [[ "$CURRENT_LINK" == *"green"* ]]; then
            ACTIVE_VERSION="green"
            DEPLOY_VERSION="blue"
          else
            ACTIVE_VERSION="none"
            DEPLOY_VERSION="blue"
          fi
          
          echo "active_version=$ACTIVE_VERSION" >> $GITHUB_OUTPUT
          echo "deploy_version=$DEPLOY_VERSION" >> $GITHUB_OUTPUT
          
          echo "ğŸ¯ Active: $ACTIVE_VERSION"
          echo "ğŸ¯ Deploying to: $DEPLOY_VERSION"
      
      # ==================== PREPARE DEPLOYMENT ====================
      - name: ğŸ“ Prepare Deployment Directory
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            set -e
            
            DEPLOY_DIR="${{ env.NGINX_ROOT }}/${{ steps.detect_version.outputs.deploy_version }}"
            
            # Create deployment directory
            sudo mkdir -p "$DEPLOY_DIR"
            
            # Clean existing files (but keep directory)
            if [ -d "$DEPLOY_DIR" ]; then
              echo "ğŸ§¹ Cleaning $DEPLOY_DIR..."
              sudo find "$DEPLOY_DIR" -mindepth 1 -delete
            fi
            
            # Set proper ownership
            sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} "$DEPLOY_DIR"
            
            echo "âœ… Deployment directory ready: $DEPLOY_DIR"
          ENDSSH
      
      - name: ğŸ“¤ Upload Build to Server
        run: |
          echo "ğŸ“¤ Uploading build files..."
          
          # Create temporary archive
          tar -czf build.tar.gz -C build .
          
          # Upload archive
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            build.tar.gz \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:/tmp/frontend-build.tar.gz
          
          # Extract on server
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            DEPLOY_DIR="${{ env.NGINX_ROOT }}/${{ steps.detect_version.outputs.deploy_version }}"
            
            sudo tar -xzf /tmp/frontend-build.tar.gz -C "$DEPLOY_DIR"
            sudo chown -R www:www "$DEPLOY_DIR"
            sudo find "$DEPLOY_DIR" -type f -exec chmod 644 {} \;
            sudo find "$DEPLOY_DIR" -type d -exec chmod 755 {} \;
            
            # Cleanup
            rm /tmp/frontend-build.tar.gz
            
            echo "âœ… Files uploaded and extracted"
          ENDSSH
          
          rm build.tar.gz
      
      - name: ğŸ” Verify Deployment Files
        id: verify
        run: |
          FILE_CHECK=$(ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            DEPLOY_DIR="${{ env.NGINX_ROOT }}/${{ steps.detect_version.outputs.deploy_version }}"
            
            if [ -f "$DEPLOY_DIR/index.html" ]; then
              FILE_COUNT=$(find "$DEPLOY_DIR" -type f | wc -l)
              TOTAL_SIZE=$(du -sh "$DEPLOY_DIR" | cut -f1)
              echo "files=$FILE_COUNT"
              echo "size=$TOTAL_SIZE"
              echo "âœ… Verification passed: $FILE_COUNT files ($TOTAL_SIZE)"
            else
              echo "âŒ index.html not found in $DEPLOY_DIR"
              exit 1
            fi
          ENDSSH
          )
          
          echo "$FILE_CHECK"
          DEPLOYED_FILES=$(echo "$FILE_CHECK" | grep "files=" | cut -d'=' -f2)
          DEPLOYED_SIZE=$(echo "$FILE_CHECK" | grep "size=" | cut -d'=' -f2)
          
          echo "deployed_files=$DEPLOYED_FILES" >> $GITHUB_OUTPUT
          echo "deployed_size=$DEPLOYED_SIZE" >> $GITHUB_OUTPUT
      
      # ==================== TRAFFIC SWITCH ====================
      - name: ğŸ”€ Switch Traffic
        id: switch
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            set -e
            
            DEPLOY_DIR="${{ env.NGINX_ROOT }}/${{ steps.detect_version.outputs.deploy_version }}"
            CURRENT_LINK="${{ env.NGINX_ROOT }}/current"
            
            # Backup current symlink
            if [ -L "$CURRENT_LINK" ]; then
              BACKUP_LINK="${CURRENT_LINK}.backup"
              sudo cp -P "$CURRENT_LINK" "$BACKUP_LINK"
              echo "âœ… Created backup symlink"
            fi
            
            # Switch symlink
            sudo ln -sfn "$DEPLOY_DIR" "$CURRENT_LINK"
            
            # Verify symlink
            NEW_TARGET=$(readlink "$CURRENT_LINK")
            if [ "$NEW_TARGET" = "$DEPLOY_DIR" ]; then
              echo "âœ… Symlink switched: $CURRENT_LINK -> $NEW_TARGET"
            else
              echo "âŒ Symlink verification failed"
              exit 1
            fi
            
            # Reload nginx to clear cache
            sudo nginx -s reload
            echo "âœ… Nginx reloaded"
          ENDSSH
      
      - name: ğŸ§ª Verify Website Accessibility
        run: |
          sleep 2
          
          echo "ğŸ§ª Testing website accessibility..."
          
          # Test main page
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://cipher.thepaytrix.com/ || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Website accessible (HTTP $RESPONSE)"
            
            # Verify it's actually serving the new version
            CONTENT=$(curl -s https://cipher.thepaytrix.com/ | head -n 20)
            if [[ "$CONTENT" == *"CipherBank"* ]]; then
              echo "âœ… Content verification passed"
            else
              echo "âš ï¸ Warning: Expected content not found"
            fi
          else
            echo "âŒ Website accessibility test failed (HTTP $RESPONSE)"
            exit 1
          fi
      
      # ==================== CLEANUP ====================
      - name: ğŸ§¹ Cleanup Old Version
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            if [ "${{ steps.detect_version.outputs.active_version }}" != "none" ]; then
              OLD_DIR="${{ env.NGINX_ROOT }}/${{ steps.detect_version.outputs.active_version }}"
              
              # Keep the directory but mark as old (we'll clean it on next deployment)
              echo "ğŸ“Œ Keeping $OLD_DIR for potential rollback"
            fi
          ENDSSH
      
      # ==================== SUCCESS NOTIFICATION ====================
      - name: ğŸ“¢ Notify Deployment Success
        if: success()
        run: |
          DEPLOY_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC')
          
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="âœ… <b>CipherBank Frontend Deployment Successful</b>
          
          ğŸ¯ <b>Deployment Details</b>
          â€¢ Version: ${{ steps.detect_version.outputs.active_version }} â†’ <b>${{ steps.detect_version.outputs.deploy_version }}</b>
          â€¢ Build: ${{ steps.build.outputs.file_count }} files (${{ steps.build.outputs.build_size }})
          â€¢ Deployed: ${{ steps.verify.outputs.deployed_files }} files (${{ steps.verify.outputs.deployed_size }})
          
          ğŸ“Š <b>Build Info</b>
          â€¢ Commit: <code>${{ steps.vars.outputs.COMMIT_SHA }}</code>
          â€¢ Author: ${{ steps.vars.outputs.AUTHOR }}
          â€¢ Version: ${{ steps.vars.outputs.VERSION }}
          â€¢ Built: ${{ steps.vars.outputs.BUILD_TIME }}
          â€¢ Deployed: $DEPLOY_TIME
          
          ğŸŒ <b>Website</b>
          â€¢ URL: https://cipher.thepaytrix.com
          â€¢ Status: âœ… Online
          
          ğŸ’¬ <i>${{ steps.vars.outputs.COMMIT_MSG }}</i>"
      
      # ==================== FAILURE HANDLING ====================
      - name: ğŸš¨ Rollback on Failure
        if: failure() && steps.switch.outcome == 'failure'
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            echo "ğŸš¨ Deployment failed, initiating rollback..."
            
            CURRENT_LINK="${{ env.NGINX_ROOT }}/current"
            BACKUP_LINK="${CURRENT_LINK}.backup"
            
            # Restore symlink from backup if it exists
            if [ -L "$BACKUP_LINK" ]; then
              sudo cp -P "$BACKUP_LINK" "$CURRENT_LINK"
              sudo nginx -s reload
              echo "âœ… Symlink restored from backup"
            fi
            
            # Clean failed deployment
            DEPLOY_DIR="${{ env.NGINX_ROOT }}/${{ steps.detect_version.outputs.deploy_version }}"
            if [ -d "$DEPLOY_DIR" ]; then
              sudo find "$DEPLOY_DIR" -mindepth 1 -delete
              echo "âœ… Failed deployment cleaned"
            fi
            
            echo "âœ… Rollback complete, serving ${{ steps.detect_version.outputs.active_version }}"
          ENDSSH
      
      - name: ğŸ“¢ Notify Deployment Failure
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="âŒ <b>CipherBank Frontend Deployment Failed</b>
          
          ğŸš¨ <b>Failure Details</b>
          â€¢ Failed Step: ${{ steps.detect_version.outcome == 'failure' && 'Version Detection' || steps.build.outcome == 'failure' && 'React Build' || steps.verify.outcome == 'failure' && 'File Verification' || steps.switch.outcome == 'failure' && 'Traffic Switch' || 'Unknown' }}
          â€¢ Target: ${{ steps.detect_version.outputs.deploy_version }}
          
          ğŸ“Š <b>Build Info</b>
          â€¢ Commit: <code>${{ steps.vars.outputs.COMMIT_SHA }}</code>
          â€¢ Author: ${{ steps.vars.outputs.AUTHOR }}
          â€¢ Version: ${{ steps.vars.outputs.VERSION }}
          
          ğŸ”„ <b>Status</b>
          â€¢ Rollback: Initiated
          â€¢ Active: ${{ steps.detect_version.outputs.active_version }} (unchanged)
          
          ğŸ”— <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Full Logs</a>"