name: CipherBank Frontend - Blue/Green Deploy

on:
  push:
    branches: [ release ]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  APP_NAME: cipherbank-frontend
  NGINX_ROOT: /www/wwwroot/cipher.thepaytrix.com
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  SSH_HOST: ${{ secrets.GCP_HOST }}
  SSH_USER: ${{ secrets.GCP_USER }}
  SSH_KEY: ${{ secrets.GCP_SSH_KEY }}
  REACT_APP_API_URL: https://cipher.thepaytrix.com/api

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      # ==================== INITIALIZATION ====================
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ env.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
      
      - name: Set Build Variables
        id: vars
        run: |
          echo "BUILD_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "COMMIT_MSG=$(git log -1 --pretty=%B | head -n1 | sed 's/[<>]//g')" >> $GITHUB_OUTPUT
          echo "AUTHOR=$(git log -1 --pretty=format:'%an' | sed 's/[<>]//g')" >> $GITHUB_OUTPUT
          echo "VERSION=$(date +'%Y%m%d-%H%M%S')-${{ github.run_number }}" >> $GITHUB_OUTPUT
      
      - name: Notify Deployment Start
        run: |
          MESSAGE="<b>CipherBank Frontend - Deployment Started</b>

          <b>Build Information</b>
          Commit: <code>${{ steps.vars.outputs.COMMIT_SHA }}</code>
          Author: ${{ steps.vars.outputs.AUTHOR }}
          Version: ${{ steps.vars.outputs.VERSION }}
          Time: ${{ steps.vars.outputs.BUILD_TIME }}

          <b>Commit Message</b>
          ${{ steps.vars.outputs.COMMIT_MSG }}

          <b>Status:</b> Installing dependencies..."

          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="$MESSAGE"
      
      # ==================== BUILD ====================
      - name: Install Dependencies
        run: |
          echo "Installing npm packages..."
          npm ci
          echo "Dependencies installed successfully"
      
      - name: Build React App
        id: build
        env:
          CI: false
          GENERATE_SOURCEMAP: false
        run: |
          echo "Starting React build..."
          npm run build
          
          if [ $? -eq 0 ] && [ -d "build" ]; then
            BUILD_SIZE=$(du -sh build | cut -f1)
            FILE_COUNT=$(find build -type f | wc -l)
            echo "build_size=$BUILD_SIZE" >> $GITHUB_OUTPUT
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            echo "Build successful: $FILE_COUNT files ($BUILD_SIZE)"
          else
            echo "Build failed"
            exit 1
          fi
      
      - name: Notify Build Complete
        if: success()
        run: |
          MESSAGE="<b>Build Completed</b>
          Size: ${{ steps.build.outputs.build_size }}
          Files: ${{ steps.build.outputs.file_count }}

          <b>Status:</b> Uploading to server..."

          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="$MESSAGE"
      
      # ==================== DETECT ACTIVE VERSION ====================
      - name: Detect Active Version
        id: detect_version
        run: |
          CURRENT_LINK=$(ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
            "readlink ${{ env.NGINX_ROOT }}/current 2>/dev/null || echo 'none'")
          
          if [[ "$CURRENT_LINK" == *"blue"* ]]; then
            ACTIVE_VERSION="blue"
            DEPLOY_VERSION="green"
          elif [[ "$CURRENT_LINK" == *"green"* ]]; then
            ACTIVE_VERSION="green"
            DEPLOY_VERSION="blue"
          else
            ACTIVE_VERSION="none"
            DEPLOY_VERSION="blue"
          fi
          
          echo "active_version=$ACTIVE_VERSION" >> $GITHUB_OUTPUT
          echo "deploy_version=$DEPLOY_VERSION" >> $GITHUB_OUTPUT
          
          echo "Active version: $ACTIVE_VERSION"
          echo "Deploying to: $DEPLOY_VERSION"
      
      # ==================== PREPARE DEPLOYMENT ====================
      - name: Prepare Deployment Directory
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            set -e
            
            DEPLOY_DIR="${{ env.NGINX_ROOT }}/${{ steps.detect_version.outputs.deploy_version }}"
            
            sudo mkdir -p "$DEPLOY_DIR"
            
            if [ -d "$DEPLOY_DIR" ]; then
              echo "Cleaning deployment directory..."
              sudo find "$DEPLOY_DIR" -mindepth 1 -delete
            fi
            
            sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} "$DEPLOY_DIR"
            
            echo "Deployment directory ready: $DEPLOY_DIR"
          ENDSSH
      
      - name: Upload Build to Server
        run: |
          echo "Creating build archive..."
          tar -czf build.tar.gz -C build .
          
          echo "Uploading to server..."
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            build.tar.gz \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:/tmp/frontend-build.tar.gz
          
          echo "Extracting on server..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            DEPLOY_DIR="${{ env.NGINX_ROOT }}/${{ steps.detect_version.outputs.deploy_version }}"
            
            sudo tar -xzf /tmp/frontend-build.tar.gz -C "$DEPLOY_DIR"
            sudo chown -R www:www "$DEPLOY_DIR"
            sudo find "$DEPLOY_DIR" -type f -exec chmod 644 {} \;
            sudo find "$DEPLOY_DIR" -type d -exec chmod 755 {} \;
            
            rm /tmp/frontend-build.tar.gz
            
            echo "Files uploaded and extracted successfully"
          ENDSSH
          
          rm build.tar.gz
      
      - name: Verify Deployment Files
        id: verify
        run: |
          FILE_CHECK=$(ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            DEPLOY_DIR="${{ env.NGINX_ROOT }}/${{ steps.detect_version.outputs.deploy_version }}"
            
            if [ -f "$DEPLOY_DIR/index.html" ]; then
              FILE_COUNT=$(find "$DEPLOY_DIR" -type f | wc -l)
              TOTAL_SIZE=$(du -sh "$DEPLOY_DIR" | cut -f1)
              echo "files=$FILE_COUNT"
              echo "size=$TOTAL_SIZE"
              echo "Verification passed: $FILE_COUNT files ($TOTAL_SIZE)"
            else
              echo "ERROR: index.html not found in $DEPLOY_DIR"
              exit 1
            fi
          ENDSSH
          )
          
          echo "$FILE_CHECK"
          DEPLOYED_FILES=$(echo "$FILE_CHECK" | grep "files=" | cut -d'=' -f2)
          DEPLOYED_SIZE=$(echo "$FILE_CHECK" | grep "size=" | cut -d'=' -f2)
          
          echo "deployed_files=$DEPLOYED_FILES" >> $GITHUB_OUTPUT
          echo "deployed_size=$DEPLOYED_SIZE" >> $GITHUB_OUTPUT
      
      # ==================== TRAFFIC SWITCH ====================
      - name: Switch Traffic
        id: switch
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            set -e
            
            DEPLOY_DIR="${{ env.NGINX_ROOT }}/${{ steps.detect_version.outputs.deploy_version }}"
            CURRENT_LINK="${{ env.NGINX_ROOT }}/current"
            
            if [ -L "$CURRENT_LINK" ]; then
              BACKUP_LINK="${CURRENT_LINK}.backup"
              sudo cp -P "$CURRENT_LINK" "$BACKUP_LINK"
              echo "Created backup symlink"
            fi
            
            sudo ln -sfn "$DEPLOY_DIR" "$CURRENT_LINK"
            
            NEW_TARGET=$(readlink "$CURRENT_LINK")
            if [ "$NEW_TARGET" = "$DEPLOY_DIR" ]; then
              echo "Symlink switched: $CURRENT_LINK -> $NEW_TARGET"
            else
              echo "ERROR: Symlink verification failed"
              exit 1
            fi
            
            sudo nginx -s reload
            echo "Nginx reloaded successfully"
          ENDSSH
      
      - name: Verify Website Accessibility
        run: |
          sleep 3
          
          echo "Testing website accessibility..."
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://cipher.thepaytrix.com/ || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "Website accessible (HTTP $RESPONSE)"
            
            CONTENT=$(curl -s https://cipher.thepaytrix.com/ | head -n 20)
            if [[ "$CONTENT" == *"CipherBank"* ]]; then
              echo "Content verification passed"
            else
              echo "WARNING: Expected content not found"
            fi
          else
            echo "ERROR: Website accessibility test failed (HTTP $RESPONSE)"
            exit 1
          fi
      
      # ==================== CLEANUP ====================
      - name: Cleanup Old Version
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            if [ "${{ steps.detect_version.outputs.active_version }}" != "none" ]; then
              OLD_DIR="${{ env.NGINX_ROOT }}/${{ steps.detect_version.outputs.active_version }}"
              echo "Keeping $OLD_DIR for potential rollback"
            fi
          ENDSSH
      
      # ==================== SUCCESS NOTIFICATION ====================
      - name: Notify Deployment Success
        if: success()
        run: |
          DEPLOY_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC')
          
          MESSAGE="<b>✅ CipherBank Frontend - Deployment Successful</b>

          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          <b>DEPLOYMENT STATUS</b>

          <b>Active Version:</b> ${{ steps.detect_version.outputs.active_version }} → <b>${{ steps.detect_version.outputs.deploy_version }}</b>
          <b>Current Serving:</b> <code>${{ steps.detect_version.outputs.deploy_version }}</code>

          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          <b>BUILD METRICS</b>

          Build Size: ${{ steps.build.outputs.build_size }}
          Build Files: ${{ steps.build.outputs.file_count }}
          Deployed Size: ${{ steps.verify.outputs.deployed_size }}
          Deployed Files: ${{ steps.verify.outputs.deployed_files }}

          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          <b>BUILD DETAILS</b>

          Commit: <code>${{ steps.vars.outputs.COMMIT_SHA }}</code>
          Author: ${{ steps.vars.outputs.AUTHOR }}
          Version: <code>${{ steps.vars.outputs.VERSION }}</code>
          Built: ${{ steps.vars.outputs.BUILD_TIME }}
          Deployed: $DEPLOY_TIME

          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          <b>COMMIT MESSAGE</b>
          ${{ steps.vars.outputs.COMMIT_MSG }}

          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          <b>WEBSITE STATUS</b>

          URL: https://cipher.thepaytrix.com
          Health: <b>✅ Online</b>
          Response: HTTP 200"

          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="$MESSAGE"
      
      # ==================== FAILURE HANDLING ====================
      - name: Rollback on Failure
        if: failure() && steps.switch.outcome == 'failure'
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            echo "Deployment failed, initiating rollback..."
            
            CURRENT_LINK="${{ env.NGINX_ROOT }}/current"
            BACKUP_LINK="${CURRENT_LINK}.backup"
            
            if [ -L "$BACKUP_LINK" ]; then
              sudo cp -P "$BACKUP_LINK" "$CURRENT_LINK"
              sudo nginx -s reload
              echo "Symlink restored from backup"
            fi
            
            DEPLOY_DIR="${{ env.NGINX_ROOT }}/${{ steps.detect_version.outputs.deploy_version }}"
            if [ -d "$DEPLOY_DIR" ]; then
              sudo find "$DEPLOY_DIR" -mindepth 1 -delete
              echo "Failed deployment cleaned"
            fi
            
            echo "Rollback complete, serving ${{ steps.detect_version.outputs.active_version }}"
          ENDSSH
      
      - name: Notify Deployment Failure
        if: failure()
        run: |
          FAILED_STEP="Unknown"
          if [ "${{ steps.detect_version.outcome }}" = "failure" ]; then
            FAILED_STEP="Version Detection"
          elif [ "${{ steps.build.outcome }}" = "failure" ]; then
            FAILED_STEP="React Build"
          elif [ "${{ steps.verify.outcome }}" = "failure" ]; then
            FAILED_STEP="File Verification"
          elif [ "${{ steps.switch.outcome }}" = "failure" ]; then
            FAILED_STEP="Traffic Switch"
          fi
          
          MESSAGE="<b>❌ CipherBank Frontend - Deployment Failed</b>

          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          <b>FAILURE DETAILS</b>

          <b>Failed Step:</b> $FAILED_STEP
          <b>Target Version:</b> ${{ steps.detect_version.outputs.deploy_version }}
          <b>Active Version:</b> <code>${{ steps.detect_version.outputs.active_version }}</code> (unchanged)

          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          <b>BUILD DETAILS</b>

          Commit: <code>${{ steps.vars.outputs.COMMIT_SHA }}</code>
          Author: ${{ steps.vars.outputs.AUTHOR }}
          Version: <code>${{ steps.vars.outputs.VERSION }}</code>

          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          <b>ROLLBACK STATUS</b>

          Status: Initiated
          Current Serving: <code>${{ steps.detect_version.outputs.active_version }}</code>

          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          <b>ACTION REQUIRED</b>

          <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Full Deployment Logs</a>"

          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="$MESSAGE"